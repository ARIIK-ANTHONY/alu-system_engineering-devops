#!/bin/bash

# This script configures the firewall to allow traffic on ports 22, 80, 443, and 8080
# and forwards traffic from port 8080 to 80.

# Allow traffic on the necessary ports
sudo ufw allow 22/tcp    # Allow SSH
sudo ufw allow 80/tcp    # Allow HTTP
sudo ufw allow 443/tcp   # Allow HTTPS
sudo ufw allow 8080/tcp  # Allow traffic on port 8080

# Enable port forwarding from 8080 to 80
sudo ufw route allow proto tcp from any to any port 8080

# Enable IP forwarding in sysctl settings
sudo sysctl -w net.ipv4.ip_forward=1

# Persist the changes after reboot
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf

# Apply the sysctl settings
sudo sysctl -p

# Add iptables rule to forward traffic from 8080 to 80
sudo iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80

# Save iptables rules to persist after reboot
sudo sh -c 'iptables-save > /etc/iptables/rules.v4'

# Reload UFW to apply changes
sudo ufw reload

# Show UFW status to verify the applied rules
sudo ufw status verbose
